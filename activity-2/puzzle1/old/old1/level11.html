<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>المستوى الأول - بازل تلقائي</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: url('images/back1.png') no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }
    #puzzle-board {
      display: grid;
      grid-template-columns: repeat(2, 150px);
      grid-template-rows: repeat(2, 150px);
      gap: 10px;
      margin-bottom: 20px;
    }
    .drop-zone {
      width: 150px;
      height: 150px;
      border: 2px dashed #aaa;
      position: relative;
    }
    #pieces-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }
    .piece {
      width: 150px;
      height: 150px;
      cursor: grab;
    }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 20px;
    }
    .controls img {
      width: 120px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .controls img:hover {
      transform: scale(1.1);
    }
    .controls.hidden { display: none; }

    .balloon {
      position: absolute;
      bottom: -100px;
      width: 40px;
      height: 60px;
      background: radial-gradient(circle at 30% 30%, #f66, #c00);
      border-radius: 50% 50% 40% 40%;
      animation: float 3s linear forwards;
    }
    @keyframes float {
      0% { bottom: -100px; opacity: 1; }
      100% { bottom: 100vh; opacity: 0; }
    }
    #fullImage {
      position: absolute;
      width: 300px;
      height: 300px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
    }
  </style>
</head>
<body>
  <div id="puzzle-board">
    <div class="drop-zone" data-pos="0"></div>
    <div class="drop-zone" data-pos="1"></div>
    <div class="drop-zone" data-pos="2"></div>
    <div class="drop-zone" data-pos="3"></div>
  </div>

  <div id="pieces-container"></div>

  <div class="controls hidden" id="controlButtons">
    <img src="images/again.png" alt="استمرار" onclick="window.location.reload()" />
    <img src="images/home.png" alt="الرئيسية" onclick="window.location.href='levels.html'" />
  </div>

  <img id="fullImage" src="/mnt/data/puzzle1.png" alt="الصورة الكاملة">

  <audio id="bravoSound" src="sounds/bravo.mp3"></audio>
  <audio id="correctSound" src="sounds/correct.mp3"></audio>
  <audio id="wrongSound" src="sounds/wrong.mp3"></audio>

  <canvas id="splitter" width="300" height="300" style="display:none;"></canvas>

  <script>
    const dropZones = document.querySelectorAll(".drop-zone");
    const piecesContainer = document.getElementById("pieces-container");
    const fullImage = document.getElementById("fullImage");
    const controlButtons = document.getElementById("controlButtons");
    const bravoSound = document.getElementById("bravoSound");
    const correctSound = document.getElementById("correctSound");
    const wrongSound = document.getElementById("wrongSound");

    const imageSrc = "/mnt/data/puzzle1.png";
    const canvas = document.getElementById("splitter");
    const ctx = canvas.getContext("2d");

    const positions = [
      { pos: 0, x: 0, y: 0 },
      { pos: 1, x: 150, y: 0 },
      { pos: 2, x: 0, y: 150 },
      { pos: 3, x: 150, y: 150 }
    ];

    const dropMap = {};

    function splitImage() {
      const img = new Image();
      img.src = imageSrc;
      img.onload = () => {
        ctx.drawImage(img, 0, 0);
        const shuffled = [...positions].sort(() => Math.random() - 0.5);
        positions.forEach((p, i) => {
          const piece = document.createElement("canvas");
          piece.width = 150;
          piece.height = 150;
          const pctx = piece.getContext("2d");
          pctx.drawImage(canvas, p.x, p.y, 150, 150, 0, 0, 150, 150);

          const imgElem = document.createElement("img");
          imgElem.src = piece.toDataURL();
          imgElem.draggable = true;
          imgElem.className = "piece";
          imgElem.dataset.pos = p.pos;
          imgElem.addEventListener("dragstart", dragStart);
          piecesContainer.appendChild(imgElem);
        });
      }
    }

    function dragStart(e) {
      e.dataTransfer.setData("text/plain", e.target.dataset.pos);
    }

    dropZones.forEach(zone => {
      zone.addEventListener("dragover", e => e.preventDefault());
      zone.addEventListener("drop", function(e) {
        e.preventDefault();
        const draggedPos = e.dataTransfer.getData("text/plain");
        const piece = document.querySelector(`.piece[data-pos='${draggedPos}']`);

        if (!piece || this.firstChild) return;

        if (this.dataset.pos === draggedPos) {
          this.appendChild(piece);
          correctSound.play();
          checkCompletion();
        } else {
          wrongSound.play();
          piecesContainer.appendChild(piece);
        }
      });
    });

    function checkCompletion() {
      const done = Array.from(dropZones).every(z => z.firstChild && z.dataset.pos === z.firstChild.dataset.pos);
      if (done) {
        fullImage.style.display = 'block';
        bravoSound.play();
        launchBalloons();
        setTimeout(() => controlButtons.classList.remove("hidden"), 2000);
      }
    }

    function launchBalloons() {
      for (let i = 0; i < 15; i++) {
        const b = document.createElement("div");
        b.className = "balloon";
        b.style.left = Math.random() * 90 + "%";
        b.style.animationDuration = (2 + Math.random() * 2) + "s";
        document.body.appendChild(b);
        setTimeout(() => b.remove(), 4000);
      }
    }

    splitImage();
  </script>
</body>
</html>